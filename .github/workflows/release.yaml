name: Release
on:
  push:
    branches:
      - "**"
jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - run: bun run type-check
      - run: bun run lint
      - run: bun run test
      - run: bun run build:production

      - name: create release archive
        run: |
          rm -rf node_modules tests CONTRIBUTING.md flake.lock flake.nix phpunit.xml shell.nix
          tar -czf panel.tar.gz * .editorconfig .env.example .gitignore biome.json build.ts bun.lock

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Automated Build
          files: panel.tar.gz
          body: |
            This is an automated build of the absolute latest commit.
            
            **Metadata:**
            - Last Branch: `${{ github.ref_name }}`
            - Last Commit: `${{ github.sha }}`
            - Build ID: `${{ github.run_id }}`
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
