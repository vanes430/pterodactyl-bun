name: Release
on:
  push:
    branches:
      - "**"
jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - run: bun run type-check
      - run: bun run lint
      - run: bun run test

      - name: Build & Package DEVELOPMENT
        run: |
          bun run package:dev
          mv panel.tar.gz panel-dev.tar.gz

      - name: Build & Package DEVELOPMENT-HASHED
        run: |
          bun run package:dev-hash
          mv panel.tar.gz panel-dev-hash.tar.gz

      - name: Build & Package PRODUCTION
        run: |
          bun run package:prod
          mv panel.tar.gz panel-prod.tar.gz
          cp panel-prod.tar.gz panel.tar.gz

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Automated Build
          files: |
            panel-dev.tar.gz
            panel-dev-hash.tar.gz
            panel-prod.tar.gz
            panel.tar.gz
          body: |
            This is an automated build of the absolute latest commit.
            
            **Available Packages:**
            - `panel-prod.tar.gz`: Optimized for production (Minified + Hashed).
            - `panel-dev-hash.tar.gz`: Production-like structure but readable code (No Minify + Hashed).
            - `panel-dev.tar.gz`: Cleanest version for debugging (No Minify + No Hash).
            
            **Metadata:**
            - Last Branch: `${{ github.ref_name }}`
            - Last Commit: `${{ github.sha }}`
            - Build ID: `${{ github.run_id }}`
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
